# wunder Identity Provider - wIP

`wunder Identity Provider` or `wIP` is Identity and Access Management System for all wunder Platform. The main goal of wIP is to streamline Access Control and to centralise Identity management across all wunder Platform products - wunderDB and any service developed going forward. 

`wunder Identity Provider` provides a platform for managing access simply by hooking new services with existing Identity and profile in the system.

The high-level architecture of `wIP` consists of two primary parts - Registration and Login. `wunder Identity Provider` does both `Authentication` - of new Accounts and `Authorization` - to End-Users and clients. 

### Architecture

<img src="diagrams/WIP-Architectural-Diagram-v2.jpg" style="display: block;  margin-left: auto; margin-right: auto; width: 100%;" />


*Tracked in [Issue #1](https://github.com/TanmoySG/wunder-identity-provider/issues/1)*

# Identity Specification

Identity Specification defines an User's Profile Speccification, uID, Tokens, etc. 

## Identity Structure

**Identifiers** - `email` (user provided) & `uID` (wIP Generated)

**Credentials** - `email` & `password` (SHA256 Hashed)

## Identity Units 

Identity Units are various information bits that are stored for each user. These are provided by the user.

`Email` , `Name` , `Password` 

## Authentication Units

These are various information, like - tokens and IDs that are uses for Authentication, Authorization and Access. These are generated by the system.

`uID` , `Admin Access Token` , `Core Service Configuration` ,  `Services Subscribed` , `Service Access Tokens`

## Complete Identity Structure

The following is a rough Identity Structure that will be implemented in wIP.

```
{
  "email" : <email> ,
  "user_uID" : <wIP Generated uID > ,
  "name" : <Name of User> ,
  "password" : <SHA-256 Hash of Password> ,
  "admin_access_token" : <wIP Provisioned Token> ,
  "services" : {
    "service_1" : {
      "service_ID" : < Same as uID> ,
      "service_name" : <Name of Service> ,
      "service_access_token" : <wIP Provisioned Token> ,
      "service_config" : <JSON describing a Initial Service Config, if any>
    },
    "service_2" : {
      "service_ID" : < Same as uID> ,
      "service_name" : <Name of Service> ,
      "service_access_token" : <wIP Provisioned Token> ,
      "service_config" : <JSON describing a Initial Service Config, if any>
    },
    ...
  }
}
```

Email is used as Primary Identifier for each user.  

```
{
  "email1@test.com" : {
    "email" : <email> ,
    "user_uID" : <wIP Generated uID > ,
    "name" : <Name of User> ,
    "password" : <SHA-256 Hash of Password> ,
    "admin_access_token" : <wIP Provisioned Token> ,
    "services" : {
      "service_1" : {
        "service_ID" : < Same as uID> ,
        "service_name" : <Name of Service> ,
        "service_access_token" : <wIP Provisioned Token> ,
        "service_config" : <JSON describing a Initial Service Config, if any>
      },
      "service_2" : {
        "service_ID" : < Same as uID> ,
        "service_name" : <Name of Service> ,
        "service_access_token" : <wIP Provisioned Token> ,
        "service_config" : <JSON describing a Initial Service Config, if any>
      },
      ...
    }
  },
  "email2@test.com" : {...},
  "email3@test.com" : {...},
  ...
}
```

*Tracked in [Issue #3](https://github.com/TanmoySG/wunder-identity-provider/issues/3)*

# Access Tokens Framework

In the current wunderDB access-token system, we are using only one access token for all access - Admin Access, Service Access and App/Third-Party Client Access. This poses a serious fault that doesn't allow different levels of separation of access for different actions. The goal is to prepare a Multi-Token Multi-Level Access Token Framework for accessing different sections and actions in wPlat.

For use-case and intetion behind the Access Tokens Framework refer to [The Curious case of Login and the various Tokens](https://github.com/TanmoySG/wunder-identity-provider/blob/dev/architecture/notes.md#the-curious-case-of-login-and-the-various-tokens) in the Notes and Observations documenting the rough idea and intent behind the framework.

In this framework we'd be using three different Tokens - `Admin Access Token` , `Service Access Token` & `App Access Tokens`. The Use cases of each tokens are shown here -

![](https://github.com/TanmoySG/wunder-identity-provider/blob/dev/architecture/diagrams/Access-Types-Logic.jpg)


*Tracked in [Issue #8](https://github.com/TanmoySG/wunder-identity-provider/issues/8)*


# Registration

Registration consists of two phases - `Phase #1 - Authentication` & `Phase #2 - Authorization` 

### Phase #1 - Authentication 

User registration starts with Authentication-Key (OTP) generation. A new user is on-boarded by passing their Email to wIP. In response to the registration request, an `One-Time Password or OTP` is generated and sent to the user via e-mail. The Email address and other required data, in form of Payload is registered to the `AuthLib` - which stores all Verification Request details as `AuthLib Profiles`.

```
{
  "email" : <email of new user>
}
```

### Phase #2 - Authorization

Upon receiving the OTP, the user needs to send an `Authorization` Request with the OTP and other user information. The wIP recieves the request and the OTP and the Profile Information is cross-checked with `Auth Profiles`. Once the profile is successfully verified, an `uID` and `App Access Token` is generated by wIP and the User Information is registered as a Verified Profile in wIP and added to the wIP Profiles Storage.

```
{
  "email" : <email>,
  "otp" : <OTP>,
  ...
}
```

### AuthLib - a Secondary Authorization and Authentication storage

`AuthLib` serves as a secondary storage layer of information, required for Authentication and authorization. AuthLib helps in storing profiles while it is still un-verified , taking off load from the main Identity Profiles Storage, by providing an intermediate layer of storage. AuthLib is cleared off the payload and auth-profiles at regular intervals, upon expiry of the OTP, to save space and workload in the wIP system.


<img src="diagrams/wIP-Registration-HighLevel-v1.jpg" style="display: block;  margin-left: auto; margin-right: auto; width: 100%;" />

*Tracked in [Issue #3](https://github.com/TanmoySG/wunder-identity-provider/issues/3)*

# Login

Account Config, Settings and other Admin-Level User Information are confidential and of Highest importance. These informations are stored seperate from any data. These informations are also required to be highly secured and accessible only to the User (Account Owner). This information is accessible only through the `Admin Access Token` to only Authorized, wunder Clients like CLI tool or Wunder Control Centre, etc. 

Service level Config, settings and data are stored in Service Level Storage. While Service-Stored Data access is subject to wunder-made client and User-made/Third-Party clients, Service Configurations and special data actions (eg delete, truncate, etc.) should only be accessible to wunder-made clients. To facilitate this, separate access tokens - `Service Access Token` and `App Access Tokens` are used in wIP.

### Admin Access Token - `AdAT`

`Admin Access Tokens` are used to access the Admin Level Setting, Configurations and Informations. This Access Token ios only used by wunder made - admin panels and clients like the wunder Control Panel and not be used by any other clients. The user needs to request for access by passing the credentials to the wunder-control-panel which relays the credentials to the wIP Access Resolver. In response the Access Resolver send the `AdAT` to the client, which is usable by the client only but not viewable to the User. This token is only used by the client to access and show the user the data from the User Data Storage. 

### Service Access Token - `SAT`

Service level Access also uses credentials passed the `Service Engine` relayed to `wIP Access Resolver` to get the the `SAT` using which the Service-Specific Client (wunder-made) can perform certain Admin-level operations on data (eg delete, truncate, etc.) as well as can configure and manipulate the admin-level service settings. This token too is usable only by the wunder-made Service Clients and not viewable to the user - only data/config is accesible and viewable.

### App Access Tokens - `ApAT`

App Access tokens work opposite to the other too tokens. Unlike `AdAT` and `SAT` were not accessible/viewable to the user and were only visible to the client, `ApAT` is generated for the user to view and use to connect to the service via a third-party applications developed by the User. The third-party application/client passes the `ApAT` assigned specifically to that client to the Service Engine to verify and establish a connection. The App Tokens are matched and if found correct a `Successful Connection` message that helps the third party client to access the data. While `ApAT` is used to connect and perform operations on the data, ApAT cannot be used to perform certain admin level actions.

<img src="diagrams/Login-Architectural-Diagram-v1.jpg" style="display: block;  margin-left: auto; margin-right: auto; width: 100%;" />


### Notes and Observations

Read the unconsolidated notes and observation [here](./notes.md).
